# Руководство по миграциям

## Быстрый старт

### Вариант 1: Через Docker (рекомендуется)

Для применения всех миграций запустите:

```bash
./docker-migrate.sh upgrade
```

Скрипт автоматически:
- Применит миграции через Docker контейнер
- Перезапустит бота для применения изменений

### Вариант 2: Локально (если есть .env файл)

```bash
./migrate.sh upgrade
```

После применения миграций перезапустите бота:

```bash
docker compose restart bot
```

## Доступные команды

### Применить миграции

```bash
./migrate.sh upgrade
```

Применяет все новые миграции к базе данных.

### Откатить миграцию

```bash
./migrate.sh downgrade
```

Откатывает последнюю примененную миграцию. Требует подтверждения.

### Проверить текущую версию

```bash
./migrate.sh current
```

Показывает текущую версию схемы базы данных.

### Показать историю

```bash
./migrate.sh history
```

Показывает список всех доступных миграций.

### Проверить статус

```bash
./migrate.sh status
```

Показывает текущую версию и последние миграции.

### Создать новую миграцию

```bash
./migrate.sh create "описание изменений"
```

Автоматически создает миграцию на основе изменений в моделях.

## Структура миграций

```
migrations/
├── versions/                           # Папка с миграциями
│   ├── 2026_01_17_1700-001_initial_database_schema.py
│   └── 2026_01_23_0800-002_add_product_colors_fit_media.py
├── env.py                             # Конфигурация Alembic
├── script.py.mako                     # Шаблон для новых миграций
└── MIGRATION_GUIDE.md                 # Это руководство
```

## Текущие миграции

### 001 - Начальная схема базы данных
- Создание всех таблиц
- Индексы и связи
- Базовые данные

### 002 - Поддержка цветов, кроя и медиа для товаров
- Добавлено поле `colors` в таблицу `products` (JSONB массив)
- Добавлено поле `fit` в таблицу `products` (тип кроя)
- Добавлено поле `media` в таблицу `products` (до 10 фото/видео)
- Добавлено поле `color` в таблицу `orders` (выбранный цвет)

## Процесс разработки

### 1. Изменение моделей

Внесите изменения в файлы моделей в `src/database/models/`.

### 2. Создание миграции

```bash
./migrate.sh create "описание ваших изменений"
```

Alembic автоматически обнаружит изменения и создаст миграцию.

### 3. Проверка миграции

Откройте созданный файл в `migrations/versions/` и проверьте:
- Корректность изменений в функции `upgrade()`
- Наличие функции `downgrade()` для отката
- Правильность типов данных
- Наличие индексов где необходимо

### 4. Применение миграции

```bash
./migrate.sh upgrade
```

### 5. Перезапуск бота

```bash
docker compose restart bot
```

## Откат изменений

Если что-то пошло не так:

```bash
./migrate.sh downgrade
```

Это откатит последнюю миграцию.

## Troubleshooting

### Ошибка: "Target database is not up to date"

Примените все миграции:
```bash
./migrate.sh upgrade
```

### Ошибка: "Can't locate revision identified by..."

База данных не синхронизирована с файлами миграций. Проверьте:
1. Наличие всех файлов миграций
2. Правильность цепочки `revision` и `down_revision`

### Миграция не применяется

Проверьте логи:
```bash
./migrate.sh status
python -m alembic upgrade head --sql
```

## Лучшие практики

1. **Всегда создавайте функцию downgrade()** - это позволит откатить изменения
2. **Проверяйте миграции перед применением** - особенно автогенерированные
3. **Делайте резервные копии БД** перед применением миграций на production
4. **Не изменяйте применённые миграции** - создавайте новые
5. **Называйте миграции понятно** - чтобы было ясно, что они делают

## Примеры

### Добавление нового поля

```python
def upgrade() -> None:
    op.add_column(
        'users',
        sa.Column('avatar_url', sa.String(500), nullable=True)
    )

def downgrade() -> None:
    op.drop_column('users', 'avatar_url')
```

### Создание индекса

```python
def upgrade() -> None:
    op.create_index(
        'ix_users_email',
        'users',
        ['email']
    )

def downgrade() -> None:
    op.drop_index('ix_users_email', 'users')
```

### Изменение типа данных

```python
def upgrade() -> None:
    op.alter_column(
        'products',
        'price',
        type_=sa.DECIMAL(12, 2),
        existing_type=sa.DECIMAL(10, 2)
    )

def downgrade() -> None:
    op.alter_column(
        'products',
        'price',
        type_=sa.DECIMAL(10, 2),
        existing_type=sa.DECIMAL(12, 2)
    )
```
