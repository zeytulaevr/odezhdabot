"""–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ (–∫–Ω–æ–ø–∫–∞ –ù–∞–∑–∞–¥)."""

from aiogram import F, Router
from aiogram.fsm.context import FSMContext
from aiogram.types import CallbackQuery

from src.bot.keyboards.main_menu import (
    get_admin_panel_keyboard,
    get_superadmin_panel_keyboard,
    get_user_menu,
)
from src.core.constants import CallbackPrefix, UserRole
from src.core.logging import get_logger
from src.database.models.user import User
from src.utils.navigation import go_back

logger = get_logger(__name__)

router = Router(name="navigation")


@router.callback_query(F.data == CallbackPrefix.BACK)
async def handle_back_button(
    callback: CallbackQuery,
    state: FSMContext,
    user: User,
) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ '–ù–∞–∑–∞–¥'.

    –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ø—Ä–µ–¥—ã–¥—É—â–∏–π —ç–∫—Ä–∞–Ω –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏.
    –ï—Å–ª–∏ –∏—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é.

    Args:
        callback: Callback query
        state: FSM –∫–æ–Ω—Ç–µ–∫—Å—Ç
        user: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–∑ –ë–î
    """
    logger.info(
        "Back button pressed",
        user_id=user.id,
        telegram_id=user.telegram_id,
    )

    # –ü—ã—Ç–∞–µ–º—Å—è –≤–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏–π —ç–∫—Ä–∞–Ω
    success = await go_back(
        callback=callback,
        state=state,
        default_text=(
            "üè† <b>–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</b>\n\n"
            "–ò—Å—Ç–æ—Ä–∏—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø—É—Å—Ç–∞.\n"
            "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ –∏–∑ –º–µ–Ω—é –Ω–∏–∂–µ."
        ),
    )

    if success:
        logger.info(
            "Navigated back successfully",
            user_id=user.id,
        )
    else:
        logger.info(
            "Navigation history empty, showing main menu",
            user_id=user.id,
        )
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–µ–Ω—é –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        if user.role == UserRole.SUPER_ADMIN:
            menu_markup = get_superadmin_panel_keyboard()
            menu_title = "üëë <b>–°—É–ø–µ—Ä-–∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å</b>"
            menu_text = (
                f"{menu_title}\n\n"
                f"–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, <b>{user.full_name}</b>!\n"
                f"–†–æ–ª—å: <code>{user.role}</code>\n\n"
                f"–£ –≤–∞—Å –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º —Ñ—É–Ω–∫—Ü–∏—è–º –±–æ—Ç–∞.\n\n"
                f"–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:"
            )
        elif user.role == UserRole.ADMIN:
            menu_markup = get_admin_panel_keyboard()
            menu_title = "üë®‚Äçüíº <b>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</b>"
            menu_text = (
                f"{menu_title}\n\n"
                f"–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, <b>{user.full_name}</b>!\n"
                f"–†–æ–ª—å: <code>{user.role}</code>\n\n"
                f"–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:"
            )
        else:
            menu_markup = get_user_menu()
            menu_title = "üè† <b>–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</b>"
            menu_text = (
                f"{menu_title}\n\n"
                "–ò—Å—Ç–æ—Ä–∏—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø—É—Å—Ç–∞.\n"
                "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ –∏–∑ –º–µ–Ω—é –Ω–∏–∂–µ."
            )

        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é —Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ñ–æ—Ç–æ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏
        from aiogram.exceptions import TelegramBadRequest
        if callback.message.photo:
            # –ï—Å–ª–∏ –µ—Å—Ç—å —Ñ–æ—Ç–æ, —É–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ
            try:
                await callback.message.delete()
                await callback.message.answer(
                    text=menu_text,
                    reply_markup=menu_markup,
                    parse_mode="HTML",
                )
            except TelegramBadRequest:
                # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å, –ø—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ
                await callback.message.answer(
                    text=menu_text,
                    reply_markup=menu_markup,
                    parse_mode="HTML",
                )
        else:
            # –û–±—ã—á–Ω–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
            await callback.message.edit_text(
                text=menu_text,
                reply_markup=menu_markup,
                parse_mode="HTML",
            )
