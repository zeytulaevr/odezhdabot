# ะกะธััะตะผะฐ ะทะฐะบะฐะทะพะฒ

## ะะฑะทะพั

ะะฐะทะพะฒะฐั ะธะฝััะฐััััะบัััะฐ ะดะปั ะฟัะธะตะผะฐ ะธ ะพะฑัะฐะฑะพัะบะธ ะทะฐะบะฐะทะพะฒ ั ัะฒะตะดะพะผะปะตะฝะธัะผะธ ะฐะดะผะธะฝะธัััะฐัะพัะฐะผ ะธ ะบะปะธะตะฝัะฐะผ.

## ะกะพะทะดะฐะฝะฝัะต ะบะพะผะฟะพะฝะตะฝัั

### 1. OrderService (`src/services/order_service.py`)

ะกะตัะฒะธั ะดะปั ัะฟัะฐะฒะปะตะฝะธั ะทะฐะบะฐะทะฐะผะธ.

**ะัะฝะพะฒะฝัะต ะผะตัะพะดั:**

```python
# ะกะพะทะดะฐะฝะธะต ะทะฐะบะฐะทะฐ
order = await order_service.create_order(
    user_id=user.id,
    product_id=product.id,
    size="M",
    customer_contact="+79001234567",
)

# ะะฑะฝะพะฒะปะตะฝะธะต ััะฐัััะฐ
order = await order_service.update_order_status(
    order_id=order.id,
    status="processing",
    admin_notes="ะะฐะบะฐะท ะฟัะธะฝัั ะฒ ัะฐะฑะพัั",
)

# ะะพะปััะตะฝะธะต ะทะฐะบะฐะทะพะฒ ะฟะพะปัะทะพะฒะฐัะตะปั
orders = await order_service.get_user_orders(user_id=user.id)

# ะะพะปััะตะฝะธะต ะฝะพะฒัั ะทะฐะบะฐะทะพะฒ ะดะปั ะฐะดะผะธะฝะพะฒ
pending = await order_service.get_pending_orders(limit=50)

# ะกัะฐัะธััะธะบะฐ ะฟะพ ะทะฐะบะฐะทะฐะผ
stats = await order_service.get_order_stats()
# {
#   "new": 5,
#   "processing": 3,
#   "paid": 2,
#   "shipped": 1,
#   "completed": 10,
#   "cancelled": 2,
#   "total": 23
# }
```

### 2. NotificationService (`src/services/notification_service.py`)

ะกะตัะฒะธั ะดะปั ะพัะฟัะฐะฒะบะธ ัะฒะตะดะพะผะปะตะฝะธะน.

**ะัะฝะพะฒะฝัะต ะผะตัะพะดั:**

```python
# ะฃะฒะตะดะพะผะธัั ะฒัะตั ะฐะดะผะธะฝะพะฒ ะพ ะฝะพะฒะพะผ ะทะฐะบะฐะทะต
count = await NotificationService.notify_admins_new_order(bot, order)

# ะฃะฒะตะดะพะผะธัั ะฟะพะปัะทะพะฒะฐัะตะปั ะพ ัะพะทะดะฐะฝะธะธ ะทะฐะบะฐะทะฐ
success = await NotificationService.notify_user_order_created(bot, order)

# ะฃะฒะตะดะพะผะธัั ะฟะพะปัะทะพะฒะฐัะตะปั ะพะฑ ะธะทะผะตะฝะตะฝะธะธ ััะฐัััะฐ
success = await NotificationService.notify_user_status_change(
    bot, order, old_status="new"
)
```

**ะกัะฐัััั ะธ ัะผะพะดะทะธ:**

- ๐ new - ะะพะฒัะน
- โณ processing - ะ ะพะฑัะฐะฑะพัะบะต
- ๐ฐ paid - ะะฟะปะฐัะตะฝ
- ๐ฆ shipped - ะัะฟัะฐะฒะปะตะฝ
- โ completed - ะัะฟะพะปะฝะตะฝ
- โ cancelled - ะัะผะตะฝัะฝ

### 3. ะะปะฐะฒะธะฐัััั ะทะฐะบะฐะทะพะฒ (`src/bot/keyboards/orders.py`)

**ะะปั ะฟะพะปัะทะพะฒะฐัะตะปะตะน:**
- `get_size_selection_keyboard()` - ะฒัะฑะพั ัะฐะทะผะตัะฐ
- `get_contact_request_keyboard()` - ะทะฐะฟัะพั ะบะพะฝัะฐะบัะฐ
- `get_order_confirmation_keyboard()` - ะฟะพะดัะฒะตัะถะดะตะฝะธะต ะทะฐะบะฐะทะฐ
- `get_my_orders_keyboard()` - ะผะพะธ ะทะฐะบะฐะทั
- `get_order_detail_keyboard()` - ะดะตัะฐะปะธ ะทะฐะบะฐะทะฐ

**ะะปั ะฐะดะผะธะฝะพะฒ:**
- `get_admin_orders_filters_keyboard()` - ัะธะปัััั ะฟะพ ััะฐัััะฐะผ
- `get_order_actions_keyboard()` - ะดะตะนััะฒะธั ั ะทะฐะบะฐะทะพะผ
- `get_status_change_confirmation_keyboard()` - ะฟะพะดัะฒะตัะถะดะตะฝะธะต ัะผะตะฝั ััะฐัััะฐ

## ะะธะทะฝะตะฝะฝัะน ัะธะบะป ะทะฐะบะฐะทะฐ

### ะกัะฐัััั ะธ ะฟะตัะตัะพะดั

```
new โ processing โ paid โ shipped โ completed
  โ
cancelled
```

**ะะพะฟัััะธะผัะต ะฟะตัะตัะพะดั:**
- `new` โ `processing` ะธะปะธ `cancelled`
- `processing` โ `paid` ะธะปะธ `cancelled`
- `paid` โ `shipped`
- `shipped` โ `completed`

### ะัะพัะตัั ะพัะพัะผะปะตะฝะธั (ะฟะพะปัะทะพะฒะฐัะตะปั)

1. **ะัะพัะผะพัั ัะพะฒะฐัะฐ** ะฒ ะบะฐัะฐะปะพะณะต ะธะปะธ ะธะท ะฟะพััะฐ ะฒ ะบะฐะฝะฐะปะต
2. **ะัะฑะพั ัะฐะทะผะตัะฐ** - inline ะบะปะฐะฒะธะฐัััะฐ ั ัะฐะทะผะตัะฐะผะธ
3. **ะะฒะพะด ะบะพะฝัะฐะบัะฐ** - RequestContact ะธะปะธ ัััะฝะพะน ะฒะฒะพะด
4. **ะะพะดัะฒะตัะถะดะตะฝะธะต** - ะฟัะพะฒะตัะบะฐ ะดะฐะฝะฝัั ะธ ัะพะทะดะฐะฝะธะต ะทะฐะบะฐะทะฐ
5. **ะฃะฒะตะดะพะผะปะตะฝะธะต** - ะฟะพะปัะทะพะฒะฐัะตะปั ะธ ะฐะดะผะธะฝั ะฟะพะปััะฐัั ัะฒะตะดะพะผะปะตะฝะธั

### ะัะพัะตัั ะพะฑัะฐะฑะพัะบะธ (ะฐะดะผะธะฝ)

1. **ะะพะปััะตะฝะธะต ัะฒะตะดะพะผะปะตะฝะธั** ะพ ะฝะพะฒะพะผ ะทะฐะบะฐะทะต
2. **ะัะพัะผะพัั ะดะตัะฐะปะตะน** - ัะพะฒะฐั, ัะฐะทะผะตั, ะบะพะฝัะฐะบั ะบะปะธะตะฝัะฐ
3. **ะกะผะตะฝะฐ ััะฐัััะฐ** - ะฟะตัะตัะพะด ะฟะพ ััะฐะฟะฐะผ
4. **ะะพะฑะฐะฒะปะตะฝะธะต ะทะฐะผะตัะพะบ** - ะบะพะผะผะตะฝัะฐัะธะธ ะฟะพ ะทะฐะบะฐะทั
5. **ะฃะฒะตะดะพะผะปะตะฝะธะต ะบะปะธะตะฝัะฐ** - ะฐะฒัะพะผะฐัะธัะตัะบะธ ะฟัะธ ัะผะตะฝะต ััะฐัััะฐ

## ะะพะดะตะปั ะดะฐะฝะฝัั

### Order (ะธะท ะะ)

```python
class Order:
    id: int                      # ID ะทะฐะบะฐะทะฐ
    user_id: int                 # ID ะฟะพะปัะทะพะฒะฐัะตะปั
    product_id: int              # ID ัะพะฒะฐัะฐ
    size: str                    # ะะฐะทะผะตั (XS, S, M, L, XL, XXL)
    status: str                  # ะกัะฐััั ะทะฐะบะฐะทะฐ
    customer_contact: str        # ะะพะฝัะฐะบัะฝัะต ะดะฐะฝะฝัะต
    admin_notes: str | None      # ะะฐะผะตัะบะธ ะฐะดะผะธะฝะธัััะฐัะพัะฐ
    created_at: datetime         # ะะฐัะฐ ัะพะทะดะฐะฝะธั
    updated_at: datetime         # ะะฐัะฐ ะพะฑะฝะพะฒะปะตะฝะธั

    # Relationships
    user: User
    product: Product

    # Properties
    can_be_cancelled: bool       # ะะพะถะฝะพ ะปะธ ะพัะผะตะฝะธัั
    is_completed: bool           # ะะฐะฒะตัััะฝ ะปะธ ะทะฐะบะฐะท
```

## TODO: ะะฑัะฐะฑะพััะธะบะธ (ะฒ ัะฐะทัะฐะฑะพัะบะต)

ะกะปะตะดัััะธะต ะบะพะผะฟะพะฝะตะฝัั ะฑัะดัั ัะตะฐะปะธะทะพะฒะฐะฝั ะฒ ัะปะตะดัััะตะน ะธัะตัะฐัะธะธ:

### User handlers

**1. `src/bot/handlers/user/catalog.py`**
```python
- ะัะพัะผะพัั ะบะฐัะตะณะพัะธะน
- ะกะฟะธัะพะบ ัะพะฒะฐัะพะฒ ะฒ ะบะฐัะตะณะพัะธะธ
- ะะตัะฐะปะธ ัะพะฒะฐัะฐ
- ะะฝะพะฟะบะฐ "ะะฐะบะฐะทะฐัั"
```

**2. `src/bot/handlers/user/order_dialog.py`**
```python
# FSM States
class OrderStates(StatesGroup):
    SELECT_SIZE = State()
    ENTER_CONTACT = State()
    CONFIRM = State()

# Handlers
- start_order(product_id) - ะฝะฐัะฐะปะพ ะพัะพัะผะปะตะฝะธั
- select_size() - ะฒัะฑะพั ัะฐะทะผะตัะฐ
- enter_contact() - ะฒะฒะพะด ะบะพะฝัะฐะบัะฐ
- confirm_order() - ะฟะพะดัะฒะตัะถะดะตะฝะธะต ะธ ัะพะทะดะฐะฝะธะต
```

**3. `src/bot/handlers/user/my_orders.py`**
```python
- show_my_orders() - ัะฟะธัะพะบ ะทะฐะบะฐะทะพะฒ
- show_order_detail(order_id) - ะดะตัะฐะปะธ ะทะฐะบะฐะทะฐ
- cancel_order(order_id) - ะพัะผะตะฝะฐ ะทะฐะบะฐะทะฐ ะฟะพะปัะทะพะฒะฐัะตะปะตะผ
```

### Admin handlers

**4. `src/bot/handlers/admin/orders.py`**
```python
- show_orders(filter) - ัะฟะธัะพะบ ะทะฐะบะฐะทะพะฒ ั ัะธะปัััะพะผ
- show_order_detail(order_id) - ะดะตัะฐะปะธ ะดะปั ะฐะดะผะธะฝะฐ
- filter_orders(status) - ะฟัะธะผะตะฝะธัั ัะธะปััั
```

**5. `src/bot/handlers/admin/order_actions.py`**
```python
- change_status(order_id, new_status) - ัะผะตะฝะฐ ััะฐัััะฐ
- add_note(order_id) - ะดะพะฑะฐะฒะปะตะฝะธะต ะทะฐะผะตัะบะธ
- confirm_status_change() - ะฟะพะดัะฒะตัะถะดะตะฝะธะต ัะผะตะฝั
```

## ะัะธะผะตั ะธัะฟะพะปัะทะพะฒะฐะฝะธั

### ะกะพะทะดะฐะฝะธะต ะทะฐะบะฐะทะฐ

```python
from src.services.order_service import OrderService
from src.services.notification_service import NotificationService

# ะ ะพะฑัะฐะฑะพััะธะบะต ะฟะพัะปะต ะฟะพะดัะฒะตัะถะดะตะฝะธั
order_service = OrderService(session)

# ะกะพะทะดะฐะตะผ ะทะฐะบะฐะท
order = await order_service.create_order(
    user_id=user.id,
    product_id=product.id,
    size="M",
    customer_contact=contact,
)

await session.commit()

# ะฃะฒะตะดะพะผะปัะตะผ ะฟะพะปัะทะพะฒะฐัะตะปั
await NotificationService.notify_user_order_created(bot, order)

# ะฃะฒะตะดะพะผะปัะตะผ ะฐะดะผะธะฝะพะฒ
await NotificationService.notify_admins_new_order(bot, order)
```

### ะกะผะตะฝะฐ ััะฐัััะฐ ะฐะดะผะธะฝะพะผ

```python
# ะะพะปััะฐะตะผ ััะฐััะน ััะฐััั
order = await order_service.get_order(order_id)
old_status = order.status

# ะะฑะฝะพะฒะปัะตะผ ััะฐััั
order = await order_service.update_order_status(
    order_id=order_id,
    status="processing",
    admin_notes="ะะฐะบะฐะท ะฟัะธะฝัั ะฒ ัะฐะฑะพัั"
)

await session.commit()

# ะฃะฒะตะดะพะผะปัะตะผ ะฟะพะปัะทะพะฒะฐัะตะปั
await NotificationService.notify_user_status_change(
    bot, order, old_status
)
```

## ะะพะฝัะธะณััะฐัะธั

### ะะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั

```env
# ID ะฐะดะผะธะฝะธัััะฐัะพัะพะฒ (ัะตัะตะท ะทะฐะฟัััั)
ADMIN_IDS=123456789,987654321

# ะะปั ัะฒะตะดะพะผะปะตะฝะธะน ะฒ ะฐะดะผะธะฝัะบัั ะณััะฟะฟั (ะพะฟัะธะพะฝะฐะปัะฝะพ)
ADMIN_GROUP_ID=-1001234567890
```

### ะะฐัััะพะนะบะธ ะฒ ะบะพะดะต

```python
# src/core/constants.py

class OrderStatus(str, Enum):
    NEW = "new"
    PROCESSING = "processing"
    PAID = "paid"
    SHIPPED = "shipped"
    COMPLETED = "completed"
    CANCELLED = "cancelled"
```

## ะะพะณะธัะพะฒะฐะฝะธะต

ะัะต ะพะฟะตัะฐัะธะธ ั ะทะฐะบะฐะทะฐะผะธ ะปะพะณะธัััััั:

```python
# ะกะพะทะดะฐะฝะธะต ะทะฐะบะฐะทะฐ
logger.info("Order created", order_id=order.id, user_id=user_id, product_id=product_id)

# ะกะผะตะฝะฐ ััะฐัััะฐ
logger.info("Order status updated", order_id=order_id, old_status="new", new_status="processing")

# ะฃะฒะตะดะพะผะปะตะฝะธั
logger.info("Admin notified about new order", admin_id=admin_id, order_id=order.id)
logger.info("User notified about status change", user_id=user.id, order_id=order.id)
```

## ะะตะทะพะฟะฐัะฝะพััั

1. **ะะฐะปะธะดะฐัะธั ัะฐะทะผะตัะพะฒ** - ะฟัะพะฒะตัะบะฐ ะดะพัััะฟะฝัั ัะฐะทะผะตัะพะฒ ัะพะฒะฐัะฐ
2. **ะัะพะฒะตัะบะฐ ะฟัะฐะฒ** - ัะพะปัะบะพ ะฐะดะผะธะฝั ะผะพะณัั ะผะตะฝััั ััะฐัััั
3. **ะัะพะฒะตัะบะฐ ะพัะผะตะฝั** - ะผะพะถะฝะพ ะพัะผะตะฝะธัั ัะพะปัะบะพ ะฝะพะฒัะต/ะฒ ะพะฑัะฐะฑะพัะบะต
4. **ะะพะณะธัะพะฒะฐะฝะธะต** - ะฒัะต ะดะตะนััะฒะธั ะทะฐะฟะธััะฒะฐัััั

## ะะฐััะธัะตะฝะธั (ะฑัะดััะตะต)

- [ ] ะะพะปะธัะตััะฒะพ ัะพะฒะฐัะพะฒ ะฒ ะทะฐะบะฐะทะต
- [ ] ะะพัะทะธะฝะฐ (ะฝะตัะบะพะปัะบะพ ัะพะฒะฐัะพะฒ ะฒ ะพะดะฝะพะผ ะทะฐะบะฐะทะต)
- [ ] ะะดัะตั ะดะพััะฐะฒะบะธ
- [ ] ะกะฟะพัะพะฑ ะพะฟะปะฐัั
- [ ] ะะฝัะตะณัะฐัะธั ั ะฟะปะฐัะตะถะฝัะผะธ ัะธััะตะผะฐะผะธ
- [ ] ะขัะตะบะบะธะฝะณ ะฟะพััะปะบะธ
- [ ] ะัะทัะฒั ะฟะพัะปะต ะฒัะฟะพะปะฝะตะฝะธั ะทะฐะบะฐะทะฐ
- [ ] ะะพะฒัะพัะฝัะน ะทะฐะบะฐะท
- [ ] ะััะพัะธั ะธะทะผะตะฝะตะฝะธะน ััะฐัััะฐ
- [ ] ะญะบัะฟะพัั ะทะฐะบะฐะทะพะฒ ะฒ Excel
- [ ] ะะฒัะพะผะฐัะธัะตัะบะธะต ะฝะฐะฟะพะผะธะฝะฐะฝะธั ะฐะดะผะธะฝะฐะผ
- [ ] SLA ะดะปั ะพะฑัะฐะฑะพัะบะธ ะทะฐะบะฐะทะพะฒ

## ะะตััะธะบะธ ะธ ะฐะฝะฐะปะธัะธะบะฐ

```python
# ะะพะปััะธัั ััะฐัะธััะธะบั
stats = await order_service.get_order_stats()

# ะะพะฝะฒะตััะธั
total_orders = stats["total"]
completed_orders = stats["completed"]
conversion_rate = (completed_orders / total_orders) * 100 if total_orders > 0 else 0

# ะัะพัะตะฝั ะพัะผะตะฝ
cancelled_orders = stats["cancelled"]
cancel_rate = (cancelled_orders / total_orders) * 100 if total_orders > 0 else 0
```

## ะะพะดะดะตัะถะบะฐ

ะัะธ ะฒะพะทะฝะธะบะฝะพะฒะตะฝะธะธ ะฟัะพะฑะปะตะผ ะฟัะพะฒะตัััะต:

1. **ADMIN_IDS** ะฝะฐัััะพะตะฝ ะฒ `.env`
2. **ะัะฐะฒะฐ ะฑะพัะฐ** ะฝะฐ ะพัะฟัะฐะฒะบั ัะพะพะฑัะตะฝะธะน ะฟะพะปัะทะพะฒะฐัะตะปัะผ
3. **ะะพะดะตะปั Order** ัััะตััะฒัะตั ะฒ ะะ (ะผะธะณัะฐัะธะธ ะฟัะธะผะตะฝะตะฝั)
4. **ะะพะณะธ** ะดะปั ะดะตัะฐะปะตะน ะพัะธะฑะพะบ

## ะัะธะผะตัั ัะฒะตะดะพะผะปะตะฝะธะน

### ะะพะฒัะน ะทะฐะบะฐะท (ะฐะดะผะธะฝะฐะผ)

```
๐ ะะพะฒัะน ะทะฐะบะฐะท #123

๐ค ะะปะธะตะฝั: ะะฒะฐะฝ ะะฒะฐะฝะพะฒ
๐ฆ ะขะพะฒะฐั: ะคััะฑะพะปะบะฐ Oversize
๐ฐ ะฆะตะฝะฐ: 1999 โฝ
๐ ะะฐะทะผะตั: M
๐ ะะพะฝัะฐะบั: +79001234567
๐ ะะฐัะฐ: 21.01.2026 18:30

ะะปั ะพะฑัะฐะฑะพัะบะธ ะทะฐะบะฐะทะฐ ะธัะฟะพะปัะทัะนัะต ะบะพะผะฐะฝะดั /admin
```

### ะะพะดัะฒะตัะถะดะตะฝะธะต ะทะฐะบะฐะทะฐ (ะบะปะธะตะฝัั)

```
โ ะะฐั ะทะฐะบะฐะท ะฟัะธะฝัั!

๐ ะะพะผะตั ะทะฐะบะฐะทะฐ: #123
๐ฆ ะขะพะฒะฐั: ะคััะฑะพะปะบะฐ Oversize
๐ฐ ะฆะตะฝะฐ: 1999 โฝ
๐ ะะฐะทะผะตั: M

ะั ัะฒัะถะตะผัั ั ะฒะฐะผะธ ะฒ ะฑะปะธะถะฐะนัะตะต ะฒัะตะผั.
ะกะปะตะดะธัะต ะทะฐ ััะฐัััะพะผ ะทะฐะบะฐะทะฐ ะฒ ัะฐะทะดะตะปะต 'ะะพะธ ะทะฐะบะฐะทั'.
```

### ะะทะผะตะฝะตะฝะธะต ััะฐัััะฐ (ะบะปะธะตะฝัั)

```
โณ ะกัะฐััั ะทะฐะบะฐะทะฐ ะธะทะผะตะฝัะฝ

๐ ะะฐะบะฐะท: #123
๐ฆ ะขะพะฒะฐั: ะคััะฑะพะปะบะฐ Oversize
๐ ะะฐะทะผะตั: M

ะกัะฐััะน ััะฐััั: ะะพะฒัะน
ะะพะฒัะน ััะฐััั: ะ ะพะฑัะฐะฑะพัะบะต

โณ ะะฐั ะทะฐะบะฐะท ะพะฑัะฐะฑะฐััะฒะฐะตััั. ะะถะธะดะฐะนัะต ะฟะพะดัะฒะตัะถะดะตะฝะธั.
```
